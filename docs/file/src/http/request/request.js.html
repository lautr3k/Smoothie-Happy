<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/http/request/request.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/lautr3k/smoothie-happy" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-VERSION">VERSION</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">board</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/board/board.js~Board.html">Board</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-settings">settings</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">http</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-get">get</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-post">post</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-request">request</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">http/request</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/request/request.js~Request.html">Request</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-settings">settings</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">http/request/event</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/request/event/request.js~RequestEvent.html">RequestEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-BEFORE_RETRY">BEFORE_RETRY</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOWNLOAD_ABORT">DOWNLOAD_ABORT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOWNLOAD_ERROR">DOWNLOAD_ERROR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOWNLOAD_LOAD">DOWNLOAD_LOAD</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOWNLOAD_PROGRESS">DOWNLOAD_PROGRESS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-DOWNLOAD_TIMEOUT">DOWNLOAD_TIMEOUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RETRY">RETRY</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-RETRY_LIMIT">RETRY_LIMIT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UPLOAD_ABORT">UPLOAD_ABORT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UPLOAD_ERROR">UPLOAD_ERROR</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UPLOAD_LOAD">UPLOAD_LOAD</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UPLOAD_PROGRESS">UPLOAD_PROGRESS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-UPLOAD_TIMEOUT">UPLOAD_TIMEOUT</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://developer.mozilla.org/fr/docs/Web/API/ProgressEvent">ProgressEvent</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">http/request/payload</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/request/payload/attempt.js~Attempt.html">Attempt</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/request/payload/progress.js~Progress.html">Progress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/http/request/payload/response.js~Response.html">Response</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/http/request/request.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import uuid from &apos;uuid/v4&apos;
import { settings as defaults } from &apos;./settings&apos;
import * as eventTypes from &apos;./event/types&apos;
import RequestEvent from &apos;./event/request&apos;
import Progress from &apos;./payload/progress&apos;
import Response from &apos;./payload/response&apos;
import Attempt from &apos;./payload/attempt&apos;

/**
* `XMLHttpRequest` wrapper with `Promise` logic.
*
* @example
* function on(event) {
*   console.info(&apos;on:&apos;, event.type, event);
* }
*
* new Request({
*   url   : &apos;http://192.168.1.102/command&apos;,
*   method: &apos;POST&apos;,
*   data  : &apos;version\n&apos;,
*   on    : {
*     &apos;before.retry&apos;     : on,
*     &apos;retry&apos;            : on,
*     &apos;retry.limit&apos;      : on,
*
*     &apos;download.load&apos;    : on,
*     &apos;download.error&apos;   : on,
*     &apos;download.abort&apos;   : on,
*     &apos;download.timeout&apos; : on,
*     &apos;download.progress&apos;: on,
*
*     &apos;upload.load&apos;      : on,
*     &apos;upload.error&apos;     : on,
*     &apos;upload.abort&apos;     : on,
*     &apos;upload.timeout&apos;   : on,
*     &apos;upload.progress&apos;  : on
*   },
*   filters: {
*     status  : status =&gt; status === 200,
*     response: response =&gt; JSON.stringify(response)
*   }
* })
* .send()
* .then(event =&gt; {
*   console.info(&apos;then:&apos;, event);
* })
* .catch(event =&gt; {
*   console.error(&apos;catch:&apos;, event);
* });
*
* @see https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise
* @see https://pouchdb.com/2015/05/18/we-have-a-problem-with-promises.html
*/
class Request {
  /**
  * Encode data object to uri string `key_1=value_1&amp;key_2=value_2`.
  *
  * @param  {Object} data
  * @return {Object}
  */
  static encodeData(data) {
    // no data
    if (data) {
      // stringify data object
      if (typeof data === &apos;object&apos;) {
        data = Object.keys(data).map(key =&gt; {
          return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(data[key])
        }).join(&apos;&amp;&apos;)
      }

      // remove the first char if it is an &apos;?&apos;
      if (data.startsWith(&apos;?&apos;)) {
        data = data.substr(1)
      }
    }

    return data
  }

  /**
  * Join data to url.
  *
  * @param  {String}        url
  * @param  {String|Object} data
  * @return {String}
  */
  static joinUrlData(url, data) {
    return url + (url.indexOf(&apos;?&apos;) === -1 ? &apos;?&apos; : &apos;&amp;&apos;) + Request.encodeData(data)
  }

  /**
  * @param {Object} settings See {@link src/http/request/settings.js~settings} for defaults keys/values.
  */
  constructor(settings = {}) {
    /**
    * Request settings, see {@link src/http/request/settings.js~settings} for defaults keys/values.
    * @type {Object}
    * @protected
    */
    this.settings = Object.assign({}, defaults, settings)

    /**
    * Unique identifier (uuid/v4).
    * @type {String}
    * @protected
    */
    this.uuid = uuid()

    /**
    * Creation time.
    * @type {Integer}
    * @protected
    */
    this.time = Date.now()

    /**
    * Send time.
    * @type {Integer}
    * @protected
    */
    this.sendTime = null

    /**
    * Elapsed time.
    * @type {Integer}
    * @protected
    */
    this.elapsedTime = null

    /**
    * Number of attempts.
    * @type {Integer}
    * @protected
    */
    this.attempts = 0

    /**
    * `XMLHttpRequest` instance.
    * @type {XMLHttpRequest}
    * @protected
    */
    this.xhr = null
  }

  /**
  * Trigger an user defined event.
  *
  * @throws {Error}
  */
  _triggerEvent(event) {
    if (typeof this.settings.on[event.type] === &apos;function&apos;) {
      this.settings.on[event.type](event)
    }
  }

  /**
  * Send the request and return a Promise.
  *
  * @return {Promise}
  * @throws {Error}
  */
  _send() {
    // prevent calling twice
    if (this.xhr) {
      throw new Error(&apos;You can not send the same request twice.&apos;)
    }

    // increment attempts counter
    this.attempts++

    // set send time
    this.sendTime = Date.now()

    // local settings
    let settings = Object.assign({}, this.settings)

    // normalize settings
    settings.url    = settings.url.trim()
    settings.method = settings.method.toUpperCase()
    settings.data   = Request.encodeData(settings.data)

    if (settings.method !== &apos;POST&apos; &amp;&amp; settings.data) {
      // append data to uri and reset data
      settings.url  = Request.joinUrlData(settings.url, settings.data)
      settings.data = null
    }

    // wrap the request in promise
    return new Promise((resolve, reject) =&gt; {
      // create http request object
      this.xhr = new XMLHttpRequest()

      // override mime type
      this.xhr.overrideMimeType(settings.mimeType)

      // open async request
      this.xhr.open(settings.method, settings.url, true)

      // status
      let rejected = false

      // create, trigger and return an RequestEvent
      let createEvent = (type, event, payload = null) =&gt; {
        let requestEvent = new RequestEvent(type, event, this, payload)
        ! rejected &amp;&amp; this._triggerEvent(requestEvent)
        return requestEvent
      }

      // on abort, error, timeout
      let _reject = (type, event, error) =&gt; {
        this.elapsedTime = Date.now() - this.sendTime
        reject(createEvent(type, event, error instanceof Error ? error : new Error(error)))
        rejected = true
      }

      let onAbort = (type, event) =&gt; {
        _reject(type, event, &apos;Connection aborted.&apos;)
      }

      let onError = (type, event) =&gt; {
        _reject(type, event, &apos;Unknown network error.&apos;)
      }

      let onTimeout = (type, event) =&gt; {
        _reject(type, event, &apos;Connection timed out (&gt;&apos; + settings.timeout + &apos;ms).&apos;)
      }

      // on progress
      let onProgress = (type, event) =&gt; {
        createEvent(type, event, new Progress(event))
      }

      // on load
      let onLoad = (type, event) =&gt; {
        // check status
        let status = this.xhr.status

        if (! status) {
          return _reject(eventTypes.DOWNLOAD_ERROR, event, &apos;Unknown HTTP error.&apos;)
        }

        // let user check the status
        if (typeof settings.filters.status === &apos;function&apos;) {
          status = settings.filters.status(status)
        }

        if (! status) {
          return _reject(type, event, this.xhr.status + &apos; &apos; + this.xhr.statusText)
        }

        // response payload
        let payload

        try { // catch filter error
          payload = new Response(this.xhr, settings.filters.response)
        }
        catch (error) {
          return _reject(type, event, error)
        }

        // set elapsed time
        this.elapsedTime = Date.now() - this.sendTime

        // resolve the promise
        resolve(createEvent(type, event, payload))
      }

      let onUploaLoad = (type, event) =&gt; {
        createEvent(type, event, settings.data)
      }

      // download events
      this.xhr.onload     = event =&gt; onLoad(eventTypes.DOWNLOAD_LOAD, event)
      this.xhr.onabort    = event =&gt; onAbort(eventTypes.DOWNLOAD_ABORT, event)
      this.xhr.onerror    = event =&gt; onError(eventTypes.DOWNLOAD_ERROR, event)
      this.xhr.ontimeout  = event =&gt; onTimeout(eventTypes.DOWNLOAD_TIMEOUT, event)
      this.xhr.onprogress = event =&gt; onProgress(eventTypes.DOWNLOAD_PROGRESS, event)

      // upload events
      this.xhr.upload.onload     = event =&gt; onProgress(eventTypes.UPLOAD_LOAD, event)
      this.xhr.upload.onabort    = event =&gt; onAbort(eventTypes.UPLOAD_ABORT, event)
      this.xhr.upload.onerror    = event =&gt; onError(eventTypes.UPLOAD_ERROR, event)
      this.xhr.upload.ontimeout  = event =&gt; onTimeout(eventTypes.UPLOAD_TIMEOUT, event)
      this.xhr.upload.onprogress = event =&gt; onProgress(eventTypes.UPLOAD_PROGRESS, event)

      // set request headers
      if (settings.headers) {
        for (let header in settings.headers) {
          this.xhr.setRequestHeader(header, settings.headers[header])
        }
      }

      // set request timeout
      this.xhr.timeout = settings.timeout

      // send the request
      this.xhr.send(settings.data)
    })
  }

  /**
  * Send the request and return a Promise.
  *
  * @return {Promise}
  */
  send() {
    return this._send().catch(event =&gt; {
      // trigger user callback
      let triggerEvent = (type, event) =&gt; this._triggerEvent(
        new RequestEvent(type, event.event, this, new Attempt(this))
      )

      // retry on timeout error if attempts limit is not reached
      if (event.type.endsWith(&apos;timeout&apos;)) {
        if (this.attempts &lt; this.settings.maxAttempts) {
          // call user callback
          triggerEvent(eventTypes.BEFORE_RETRY, event)

          // delayed retry
          return new Promise((resolve, reject) =&gt; {
            setTimeout(() =&gt; {
              // reset xhr object
              this.xhr = null

              // call user callback
              triggerEvent(eventTypes.RETRY, event)

              // (re)send the request
              return this.send().then(resolve).catch(reject)
            }, this.settings.attemptDelay)
          })
        }

        // call user callback
        triggerEvent(eventTypes.RETRY_LIMIT, event)

        let payload = new Error(&apos;Too many attempts (max: &apos; + this.attempts + &apos;).&apos;)
        event       = new RequestEvent(eventTypes.DOWNLOAD_ERROR, event.event, this, payload)
      }

      return Promise.reject(event)
    })
  }

  /**
  * Abort the this.
  */
  abort() {
    this.xhr &amp;&amp; this.xhr.abort()
  }
}

export default Request
export { Request }
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.5.2)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
